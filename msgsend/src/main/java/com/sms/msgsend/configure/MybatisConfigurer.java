package com.sms.msgsend.configure;


import com.sms.msgsend.constants.ProjectConstant;
import org.apache.ibatis.session.SqlSessionFactory;
import org.mybatis.spring.SqlSessionFactoryBean;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.support.PathMatchingResourcePatternResolver;
import org.springframework.core.io.support.ResourcePatternResolver;
import tk.mybatis.spring.mapper.MapperScannerConfigurer;

import javax.sql.DataSource;
import java.util.Properties;


/**
 * desc MyBatis 启动类
 * @author  wend
 */
@Configuration
public class MybatisConfigurer {


        @Bean
        public SqlSessionFactory sqlSessionFactoryBean(DataSource dataSource) throws Exception {
            SqlSessionFactoryBean factory = new SqlSessionFactoryBean();
            factory.setDataSource(dataSource);
            factory.setTypeAliasesPackage(ProjectConstant.MODEL_PACKAGE);
            //开启驼峰转换
            SqlSessionFactory sqlSessionFactory = factory.getObject();
            org.apache.ibatis.session.Configuration configuration =  sqlSessionFactory.getConfiguration();
            configuration.setMapUnderscoreToCamelCase(true);
            //添加XML目录
            ResourcePatternResolver resolver = new PathMatchingResourcePatternResolver();
            factory.setMapperLocations(resolver.getResources("classpath:mapper/*.xml"));
            return factory.getObject();
        }

        @Bean
        public MapperScannerConfigurer mapperScannerConfigurer() {
            MapperScannerConfigurer mapperScannerConfigurer = new MapperScannerConfigurer();
            mapperScannerConfigurer.setSqlSessionFactoryBeanName("sqlSessionFactoryBean");
            mapperScannerConfigurer.setBasePackage(ProjectConstant.MAPPER_PACKAGE);

            //配置通用Mapper，详情请查阅官方文档
            Properties properties = new Properties();
            properties.setProperty("mappers",ProjectConstant.MAPPER_INTERFACE_REFERENCE);
            //insert、update是否判断字符串类型!='' 即 test="str != null"表达式内是否追加 and str != ''
            properties.setProperty("notEmpty", "false");
            properties.setProperty("IDENTITY", "MYSQL");
            mapperScannerConfigurer.setProperties(properties);

            return mapperScannerConfigurer;
        }

    }

